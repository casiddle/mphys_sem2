import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns
from matplotlib.colors import Normalize
import os

# Get the directory where the current script is located
script_dir = os.path.dirname(os.path.abspath(__file__))
# Change the current working directory to the script directory
os.chdir(script_dir)

def theta_to_r(theta, distance):
    r=distance*np.tan(theta)
    return r


data_set=r"data_sets\output_test_96.csv"
df = pd.read_csv(data_set)
df = df.drop(columns=['Initial emittance'])


# Apply the function to the column
df['Mean Radiation Radius'] = df['Mean Theta'].apply(lambda theta: theta_to_r(theta, 11))
df['UV Percentage']=df['No. UV Photons']/df['Total no. Photons']
df['Other Percentage']=df['No. Other Photons']/df['Total no. Photons']


df = df.drop(columns=['No. UV Photons','No. Other Photons','No. X-ray Photons'])


print(df.columns)
print(df.describe(include='all'))


# Calculate the correlation matrices for different methods
correlation_pearson = df.corr(method='pearson')
correlation_spearman = df.corr(method='spearman')
correlation_kendall = df.corr(method='kendall')

# Plot Pearson correlation matrix with bwr colormap
plt.figure(figsize=(12, 10))
sns.heatmap(correlation_pearson, annot=True, cmap="bwr", fmt=".2f", linewidths=0.5)
plt.title("Pearson Correlation Matrix")
#plt.show()

# Plot Spearman correlation matrix with bwr colormap
plt.figure(figsize=(12, 10))
sns.heatmap(correlation_spearman, annot=True, cmap="bwr", fmt=".2f", linewidths=0.5)
plt.title("Spearman Correlation Matrix")
#plt.show()

# Plot Kendall correlation matrix with bwr colormap
plt.figure(figsize=(12, 10))
sns.heatmap(correlation_kendall, annot=True, cmap="bwr", fmt=".2f", linewidths=0.5)
plt.title("Kendall Correlation Matrix")
#plt.show()

#Rank correlations
# Convert the correlation matrix into a long format
correlation_long = correlation_kendall.unstack().reset_index()
# Rename columns for clarity
correlation_long.columns = ['Feature 1', 'Feature 2', 'Correlation']
# Remove self-correlations (where Feature 1 == Feature 2)
correlation_long = correlation_long[correlation_long['Feature 1'] != correlation_long['Feature 2']]
# Drop duplicate pairs (each correlation appears twice in a symmetric matrix)
correlation_long['Sorted Pair'] = correlation_long.apply(lambda x: tuple(sorted([x['Feature 1'], x['Feature 2']])), axis=1)
correlation_long = correlation_long.drop_duplicates(subset=['Sorted Pair']).drop(columns=['Sorted Pair'])
# Sort by absolute correlation value (strongest relationships first)
correlation_long = correlation_long.reindex(correlation_long['Correlation'].abs().sort_values(ascending=False).index)
# Display the ranked correlation pairs
print(correlation_long)
# Save the ranked correlation pairs to a CSV file
correlation_long.to_csv('correlation_matrix_ranked.csv', index=False)

correlation_df=pd.read_csv('correlation_matrix_ranked.csv')

# Filter rows where 'Feature 1' or 'Feature 2' contains 'Emittance'
emittance_filtered_df = correlation_df[(correlation_df["Feature 1"]=="Emittance") | (correlation_df["Feature 2"]=="Emittance")]
print(emittance_filtered_df.head(10))

beam_spread_filtered_df = correlation_df[(correlation_df["Feature 1"]=="Beam Spread") | (correlation_df["Feature 2"]=="Beam Spread")]
print(beam_spread_filtered_df.head(10))

beam_energy_filtered_df = correlation_df[(correlation_df["Feature 1"]=="Beam Energy") | (correlation_df["Feature 2"]=="Beam Energy")]
print(beam_energy_filtered_df.head(10))


X = df[['Emittance','Beam Spread','Beam Energy', 'X-ray Percentage',
        'X-ray Critical Energy','Mean Radiation Radius','UV Percentage','Other Percentage','Critical Energy']]

correlation_matrix = X.corr(method='kendall')
plt.figure(figsize=(14, 12))
sns.heatmap(correlation_matrix, annot=True, cmap="bwr", fmt=".2f", linewidths=0.5)
plt.title("Heatmap for Correlation Matrix")
plt.xticks(rotation=45, ha='right')
plt.tight_layout()
plt.savefig('Plots/correlation_heatmap.png')
#plt.show()